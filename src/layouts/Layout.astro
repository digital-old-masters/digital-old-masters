---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import '../styles/global.css';

interface Props {
	title: string;
	description?: string;
	breadcrumbs?: { label: string; href: string }[];
    frontmatter?: any; /* Markdownから渡されるデータ */
}

const { title, description, breadcrumbs, frontmatter } = Astro.props;
const pageTitle = frontmatter?.title || title;
const pageDescription = frontmatter?.description || description || "Archiving beauty into the semantic layer.";
const currentUrl = Astro.url.href;

// --- 関連記事ロジック (Only for Posts) ---
let relatedPosts: any[] = [];
if (frontmatter && frontmatter.tags) {
    const allPosts = Object.values(import.meta.glob('../pages/posts/*.md', { eager: true }));
    relatedPosts = allPosts
        .filter((post: any) => 
            post.url !== Astro.url.pathname && // 自分自身は除外
            post.frontmatter.tags &&
            post.frontmatter.tags.some((t: string) => frontmatter.tags.includes(t)) // 同じタグを含む
        )
        .sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime())
        .slice(0, 3); // 最大3件
}
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={pageDescription} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{pageTitle} | Digital Old Masters</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400&display=swap" rel="stylesheet">
	</head>
	<body>
        <Header activePath={Astro.url.pathname} />

        <main>
            {breadcrumbs && (
                <nav class="breadcrumbs">
                    {breadcrumbs.map((crumb, index) => (
                        <>
                            <a href={crumb.href}>{crumb.label}</a>
                            {index < breadcrumbs.length - 1 && <span class="separator">/</span>}
                        </>
                    ))}
                </nav>
            )}

            <slot />

            {frontmatter && (
                <div class="post-footer">
                    
                    <div class="share-section">
                        <span class="share-label">Share:</span>
                        <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(pageTitle)}&url=${encodeURIComponent(currentUrl)}`} target="_blank" rel="noopener noreferrer" class="share-link">
                            X (Twitter)
                        </a>
                    </div>

                    {relatedPosts.length > 0 && (
                        <div class="related-section">
                            <h3>Related Works</h3>
                            <div class="grid related-grid">
                                {relatedPosts.map((post: any) => (
                                    <article class="card">
                                        <div class="card-image" style="height: 150px;">
                                            {post.frontmatter.image && 
                                            <img src={import.meta.env.BASE_URL + post.frontmatter.image} alt={post.frontmatter.title} loading="lazy" />
                                            }
                                        </div>
                                        <div class="content" style="padding: 1rem;">
                                            <div class="meta">
                                                <span class="date">{post.frontmatter.artDate}</span>
                                            </div>
                                            <h3 style="font-size: 1rem; margin: 0.5rem 0;">
                                                <a href={post.url} class="main-link">
                                                    {post.frontmatter.title}
                                                </a>
                                            </h3>
                                        </div>
                                    </article>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            )}
        </main>

        <Footer />
	</body>
</html>