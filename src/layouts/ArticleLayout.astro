---
/* src/layouts/ArticleLayout.astro - Specialized for Articles (Type-Safe Fix) */
import Layout from './Layout.astro';
import ArticleCarousel from '../components/ArticleCarousel.astro';
import '../styles/layouts/article.css';

/* Props定義: Markdownから渡される情報を型定義 */
interface Props {
  content: {
    title: string;
    description: string;
    artDate: string;
    image?: string;
    tags?: string[];
    category?: string;
    location?: string;
  };
  headings: any[];
}

const { content } = Astro.props;
/* 分割代入時にデフォルト値を与えるか、あるいはLayout側でオプショナルにする */
const { title, description, artDate, image, tags, category, location } = content;

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const currentUrl = Astro.url.href;

/* -----------------------------------------------------------------
   Logic 1: パンくずリストの修正 (Fix 404)
   ----------------------------------------------------------------- */
const breadcrumbs = [
    { label: 'Home', href: `${baseUrl}/` },
    { label: 'Archives', href: `${baseUrl}/archives` },
    ...(category ? [{ 
        label: category, 
        /* toLowerCase() でURL正規化 */
        href: `${baseUrl}/category/${category.toLowerCase()}` 
    }] : []),
    { label: title, href: currentUrl }
];

/* -----------------------------------------------------------------
   Logic 2: 関連記事の取得 (Carousel用)
   ----------------------------------------------------------------- */
let relatedPosts: any[] = [];
if (tags) {
    const allPosts = Object.values(import.meta.glob('../pages/posts/*.{md,mdx}', { eager: true }));
    relatedPosts = allPosts
        .filter((post: any) => 
            post.url !== Astro.url.pathname && 
            post.frontmatter.tags &&
            post.frontmatter.tags.some((t: string) => tags.includes(t))
        )
        .sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime())
        .slice(0, 5);
}
---

<Layout 
    title={title} 
    description={description} 
    image={image} 
    artDate={artDate} 
    location={location}
    breadcrumbs={breadcrumbs}
    frontmatter={content}
>
    
    {/* 記事本文 */}
    <article class="article-content">
        <slot />
    </article>

    {/* 記事フッターエリア */}
    <div class="post-footer">
        
        {/* カテゴリとタグのナビゲーション */}
        <div class="article-taxonomy">
            {category && (
                <div class="taxonomy-group">
                    <span class="taxonomy-label">Category:</span>
                    <a href={`${baseUrl}/category/${category.toLowerCase()}`} class="category-pill">
                        {category}
                    </a>
                </div>
            )}
            
            {tags && tags.length > 0 && (
                <div class="taxonomy-group">
                    <span class="taxonomy-label">Tags:</span>
                    <div class="tag-list">
                        {tags.map((tag) => (
                            <a href={`${baseUrl}/tags/${tag}`} class="tag-pill">#{tag}</a>
                        ))}
                    </div>
                </div>
            )}
        </div>

        {/* シェアボタン (Web Share API + Copy + X) */}
        <div class="share-actions">
            <span class="share-label">Share this work:</span>
            <div class="share-buttons">
                {/* 1. X (Twitter) */}
                <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(currentUrl)}`} 
                   target="_blank" rel="noopener noreferrer" class="share-btn is-twitter" aria-label="Share on X">
                   X
                </a>
                
                {/* 2. Copy Link */}
                <button id="copyLinkBtn" class="share-btn is-copy" data-url={currentUrl} aria-label="Copy Link">
                    Copy Link
                </button>

                {/* 3. Native Share */}
                <button id="nativeShareBtn" class="share-btn is-native" data-title={title} data-url={currentUrl} aria-label="Share">
                    Share
                </button>
            </div>
            <span id="copyMessage" class="copy-feedback">Copied!</span>
        </div>

        {/* 関連記事カルーセル */}
        {relatedPosts.length > 0 && (
            <div class="related-section-carousel">
                <h3 class="related-title">Related Works</h3>
                <ArticleCarousel posts={relatedPosts} title="" />
            </div>
        )}
    </div>
</Layout>

<script>
    function initShareButtons() {
        const copyBtn = document.getElementById('copyLinkBtn');
        const shareBtn = document.getElementById('nativeShareBtn');
        const feedback = document.getElementById('copyMessage');

        if (copyBtn && feedback) {
            /* onclickで上書きすればリスナー重複を防げる */
            copyBtn.onclick = async () => {
                const url = copyBtn.dataset.url;
                if (url) {
                    try {
                        await navigator.clipboard.writeText(url);
                        feedback.classList.add('visible');
                        setTimeout(() => feedback.classList.remove('visible'), 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                }
            };
        }

        if (shareBtn) {
            if (navigator.share) {
                shareBtn.style.display = 'inline-flex';
                shareBtn.onclick = () => {
                    const title = shareBtn.dataset.title || '';
                    const url = shareBtn.dataset.url || '';
                    if (title && url) {
                        navigator.share({ title, url }).catch(console.error);
                    }
                };
            } else {
                shareBtn.style.display = 'none';
            }
        }
    }

    document.addEventListener('astro:page-load', initShareButtons);
</script>