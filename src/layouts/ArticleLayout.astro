---
/* src/layouts/ArticleLayout.astro - Phase 3: The Awakening (Fixed) */
import Layout from './Layout.astro';
import ArticleCarousel from '../components/ArticleCarousel.astro';
import '../styles/layouts/article.css';
/* lib/cloudinary.tsからメタデータ取得機能をインポート */
import { getImageMetadata } from '../lib/cloudinary';

interface Props {
  content: {
    title: string;
    description: string;
    artDate: string;
    image?: string;
    tags?: string[];
    category?: string;
    location?: string;
  };
  headings: any[];
}

const { content } = Astro.props;
const { title, description, artDate, image, tags, category, location } = content;

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const currentUrl = Astro.url.href;
const siteUrl = Astro.site ? Astro.site.toString() : "https://digital-old-masters.com";

/* -----------------------------------------------------------------
   Logic 1: データ取得
   ----------------------------------------------------------------- */
/* 【修正】 null ではなく undefined (型定義付き) で初期化 */
let richSchema: object | undefined; 

if (image) {
    /* 1. CloudinaryからExif/IPTCを取得 */
    const imageEvidence = await getImageMetadata(image);
    
    /* 2. frontmatter + Exif/IPTC */
    richSchema = {
      "@context": "https://schema.org",
      "@type": "VisualArtwork",
      "name": title,
      "description": description,
      "url": currentUrl,
      "image": {
        "@type": "ImageObject",
        "url": imageEvidence.url,
        "width": imageEvidence.width,
        "height": imageEvidence.height,
        "description": imageEvidence.metadata.description || description,
        "author": {
            "@type": "Person",
            "name": imageEvidence.metadata.artist || "Digital Old Masters"
        },
        "dateCreated": imageEvidence.metadata.dateCreated,
        "contentLocation": {
            "@type": "Place",
            "name": location || "Japan"
        }
      },
      "dateCreated": artDate,
      "datePublished": artDate,
      "artist": { 
          "@type": "Person", 
          "name": "Digital Old Masters",
          /* 必要であればSNSリンクなどを追加 */
          // "sameAs": "https://twitter.com/..." 
      },
      "artMedium": tags ? tags.join(', ') : "Oil on Canvas",
      "copyrightHolder": {
          "@type": "Person",
          "name": imageEvidence.metadata.copyright || "Digital Old Masters"
      }
    };
}

/* -----------------------------------------------------------------
   Logic 2: パンくずリスト
   ----------------------------------------------------------------- */
const breadcrumbs = [
    { label: 'Home', href: `${baseUrl}/` },
    { label: 'Archives', href: `${baseUrl}/archives` },
    ...(category ? [{ 
        label: category, 
        href: `${baseUrl}/category/${category.toLowerCase()}` 
    }] : []),
    { label: title, href: currentUrl }
];

/* -----------------------------------------------------------------
   Logic 3: 関連記事
   ----------------------------------------------------------------- */
let relatedPosts: any[] = [];
if (tags) {
    const allPosts = Object.values(import.meta.glob('../pages/posts/*.{md,mdx}', { eager: true }));
    relatedPosts = allPosts
        .filter((post: any) => 
            post.url !== Astro.url.pathname && 
            post.frontmatter.tags &&
            post.frontmatter.tags.some((t: string) => tags.includes(t))
        )
        .sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime())
        .slice(0, 5);
}
---

<Layout 
    title={title} 
    description={description} 
    image={image} 
    artDate={artDate} 
    location={location}
    breadcrumbs={breadcrumbs}
    frontmatter={content}
    structuredData={richSchema} 
>
    {/* Layoutに渡す際、richSchemaがundefinedならLayout側のデフォルトロジックが動く */}

    <article class="article-content">
        <slot />
    </article>

    <div class="post-footer">
        <div class="article-taxonomy">
            {category && (
                <div class="taxonomy-group">
                    <span class="taxonomy-label">Category:</span>
                    <a href={`${baseUrl}/category/${category.toLowerCase()}`} class="category-pill">
                        {category}
                    </a>
                </div>
            )}
            
            {tags && tags.length > 0 && (
                <div class="taxonomy-group">
                    <span class="taxonomy-label">Tags:</span>
                    <div class="tag-list">
                        {tags.map((tag) => (
                            <a href={`${baseUrl}/tags/${tag}`} class="tag-pill">#{tag}</a>
                        ))}
                    </div>
                </div>
            )}
        </div>

        <div class="share-actions">
            <span class="share-label">Share this work:</span>
            <div class="share-buttons">
                <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(currentUrl)}`} 
                   target="_blank" rel="noopener noreferrer" class="share-btn is-twitter" aria-label="Share on X">
                    X
                </a>
                <button id="copyLinkBtn" class="share-btn is-copy" data-url={currentUrl} aria-label="Copy Link">
                   Copy Link
                </button>
                <button id="nativeShareBtn" class="share-btn is-native" data-title={title} data-url={currentUrl} aria-label="Share">
                    Share
                </button>
            </div>
            <span id="copyMessage" class="copy-feedback">Copied!</span>
        </div>

        {relatedPosts.length > 0 && (
            <div class="related-section-carousel">
                <h3 class="related-title">Related Works</h3>
                <ArticleCarousel posts={relatedPosts} title="" />
            </div>
        )}
    </div>
</Layout>

<script>
    function initShareButtons() {
        const copyBtn = document.getElementById('copyLinkBtn');
        const shareBtn = document.getElementById('nativeShareBtn');
        const feedback = document.getElementById('copyMessage');

        if (copyBtn && feedback) {
            copyBtn.onclick = async () => {
                const url = copyBtn.dataset.url;
                if (url) {
                    try {
                        await navigator.clipboard.writeText(url);
                        feedback.classList.add('visible');
                        setTimeout(() => feedback.classList.remove('visible'), 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                }
            };
        }

        if (shareBtn) {
            if (navigator.share) {
                shareBtn.style.display = 'inline-flex';
                shareBtn.onclick = () => {
                    const title = shareBtn.dataset.title || '';
                    const url = shareBtn.dataset.url || '';
                    if (title && url) {
                        navigator.share({ title, url }).catch(console.error);
                    }
                };
            } else {
                shareBtn.style.display = 'none';
            }
        }
    }
    document.addEventListener('astro:page-load', initShareButtons);
</script>