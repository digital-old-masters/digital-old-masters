---
/**
 * ArtImage.astro - v1.1: Hybrid Support (Fixed)
 */
import '@/styles/components/artimage.css';
import { getCloudinaryUrl } from '@/lib/cloudinary';

interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  caption?: string;
  format?: string;
  quality?: number;
  keepMetadata?: boolean;
}

const {
  src,
  alt,
  width = 800,
  height = 600,
  caption,
  format = "webp",
  quality = 80,
  keepMetadata = true
} = Astro.props;

// --- Logic Update: 外部URL判定 ---
const isExternal = src.startsWith('http') || src.startsWith('https');

let imageUrl = src;

if (!isExternal) {
  // 内部IDの場合のみ Cloudinary URL を生成
  imageUrl = getCloudinaryUrl(src, {
    width,
    height,
    crop: 'limit',
    format,
    quality,
    keepMetadata
  });
}

const aspectRatio = `${width} / ${height}`;
---

<figure class="art-figure" style={`aspect-ratio: ${aspectRatio};`}>
  <img 
    src={imageUrl} 
    alt={alt} 
    width={width} 
    height={height}
    loading="lazy" 
    decoding="async"
    style={isExternal ? "object-fit: contain; width: 100%; height: 100%;" : ""}
  />
  {caption && <figcaption>{caption}</figcaption>}
</figure>