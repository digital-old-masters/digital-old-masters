---
/**
 * CompareSlider.astro - v2.0 Curator's Edition
 * 画質、フォーマット、メタデータ保持を手動制御可能に。
 */
import '@/styles/components/compare.css';
import { getCloudinaryUrl } from '@/lib/cloudinary';

interface Props {
  before: string;
  after: string;
  beforeLabel?: string;
  afterLabel?: string;
  width?: number;
  height?: number;
  // 追加: 画質管理プロパティ
  format?: string; 
  quality?: number;
  keepMetadata?: boolean;
}

const { 
  before, 
  after, 
  beforeLabel = "Original", 
  afterLabel = "Study",
  width = 800,
  height = 600,
  // デフォルト値
  format = "webp",
  quality = 80,
  keepMetadata = true // デフォルトで「魂」を守る設定にします
} = Astro.props;

// オプションをまとめる
const options = { 
  width, 
  height, 
  crop: 'fill', 
  gravity: 'center',
  format,
  quality,
  keepMetadata
};

const beforeSrc = getCloudinaryUrl(before, options);
const afterSrc = getCloudinaryUrl(after, options);

const aspectRatio = `${width} / ${height}`;
---

<div class="img-comp-container" style={`aspect-ratio: ${aspectRatio};`}>
  <div class="img-comp-img img-comp-overlay">
    <img src={beforeSrc} alt={beforeLabel} loading="lazy" />
    <span class="label label-before">{beforeLabel}</span>
  </div>

  <div class="img-comp-img">
    <img src={afterSrc} alt={afterLabel} loading="lazy" />
    <span class="label label-after">{afterLabel}</span>
  </div>

  <div class="img-comp-slider">
    <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
  </div>
</div>

<script>
  // Script部分は変更なし (v1.3のまま)
  function initComparisons() {
    const containers = document.getElementsByClassName("img-comp-container");
    for (let i = 0; i < containers.length; i++) {
      compareImages(containers[i] as HTMLElement);
    }

    function compareImages(container: HTMLElement) {
      let slider = container.getElementsByClassName("img-comp-slider")[0] as HTMLElement;
      let overlayDiv = container.getElementsByClassName("img-comp-overlay")[0] as HTMLElement;
      let overlayImg = overlayDiv.querySelector('img') as HTMLImageElement;
      
      let clicked = 0;
      let w = container.offsetWidth;

      if (!slider || !overlayDiv || !overlayImg) return;

      overlayImg.style.width = w + "px";

      slider.addEventListener("mousedown", slideReady);
      window.addEventListener("mouseup", slideFinish);
      slider.addEventListener("touchstart", slideReady, {passive: false});
      window.addEventListener("touchend", slideFinish);

      window.addEventListener('resize', () => { 
        w = container.offsetWidth; 
        overlayImg.style.width = w + "px";
      });

      function slideReady(e: MouseEvent | TouchEvent) {
        e.preventDefault();
        clicked = 1;
        window.addEventListener("mousemove", slideMove);
        window.addEventListener("touchmove", slideMove, {passive: false});
      }

      function slideFinish() {
        clicked = 0;
        window.removeEventListener("mousemove", slideMove);
        window.removeEventListener("touchmove", slideMove);
      }

      function slideMove(e: MouseEvent | TouchEvent) {
        if (clicked == 0) return false;
        let pos = getCursorPos(e);
        if (pos < 0) pos = 0;
        if (pos > w) pos = w;
        slide(pos);
      }

      function getCursorPos(e: MouseEvent | TouchEvent) {
        const pageX = (window.TouchEvent && e instanceof TouchEvent) ? e.changedTouches[0].pageX : (e as MouseEvent).pageX;
        const rect = container.getBoundingClientRect();
        return pageX - rect.left - window.pageXOffset;
      }

      function slide(x: number) {
        overlayDiv.style.width = x + "px";
        slider.style.left = x + "px";
      }
    }
  }
  document.addEventListener('astro:page-load', initComparisons);
  initComparisons();
</script>