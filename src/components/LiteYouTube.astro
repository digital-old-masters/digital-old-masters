---
interface Props {
  videoId: string;
  title: string;
  backgroundImage?: string; /* 追加: 自前の画像を指定可能にする */
}

const { videoId, title, backgroundImage } = Astro.props;

// 背景画像の決定ロジック:
// 指定があればそれを使い、なければYouTubeの最高画質を使う
const posterUrl = backgroundImage 
    ? backgroundImage 
    : `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
---

<div class="video-wrapper">
    <div class="video-container" data-id={videoId} style={`background-image: url('${posterUrl}');`}>
        <div class="play-button" aria-label="Play Video">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        
        <iframe 
            class="youtube-iframe"
            title={title}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
            allowfullscreen
        ></iframe>
    </div>
</div>

<script>
    function initYouTube() {
        const containers = document.querySelectorAll('.video-container');
        containers.forEach(c => {
            /* addEventListenerだと遷移のたびに増えるので、onclickプロパティを使用 */
            (c as HTMLElement).onclick = () => {
                const id = c.getAttribute('data-id');
                const iframe = c.querySelector('iframe');
                if (iframe && !iframe.src) {
                    iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
                    c.classList.add('playing');
                }
            };
        });
    }
    document.addEventListener('astro:page-load', initYouTube);
</script>

<style>
    .video-wrapper {
        max-width: 100%;
        margin: 2rem auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9; 
        cursor: pointer;
        overflow: hidden;
        /* 背景画像の設定 */
        background-size: cover;
        background-position: center;
        background-color: #000;
        transition: opacity 0.3s;
    }
    
    /* ホバー時に少し暗くして、再生ボタンを目立たせる */
    .video-container:hover { 
        opacity: 0.95;
    }
    
    .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 64px;
        height: 64px;
        background: rgba(0,0,0,0.3); /* 少し控えめに */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        z-index: 2;
        transition: all 0.2s ease-out;
        backdrop-filter: blur(4px); /* すりガラス効果 */
        border: 1px solid rgba(255,255,255,0.3);
    }
    .play-button svg { width: 32px; height: 32px; fill: currentColor; }
    .video-container:hover .play-button { 
        background: rgba(205, 133, 63, 0.9);
        transform: translate(-50%, -50%) scale(1.1); 
        border-color: transparent;
    }

    .youtube-iframe {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        border: none; opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 3;
    }
    .video-container.playing .youtube-iframe { opacity: 1; pointer-events: auto; }
    
    /* 再生中は背景（表紙）を見えなくする必要はない（iframeが上に被さるため） */
    .video-container.playing .play-button { display: none; }
</style>