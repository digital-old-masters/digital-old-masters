---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allPosts = Object.values(import.meta.glob('../posts/*.{md,mdx}', { eager: true }));
  const uniqueTags = [...new Set(allPosts.flatMap((post: any) => post.frontmatter.tags || []))];
  
  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post: any) => 
      post.frontmatter.tags && post.frontmatter.tags.includes(tag)
    ).sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime());
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');

const breadcrumbs = [
    { label: 'Home', href: '/' },
    { label: 'Archives', href: '/archives' },
    { label: `#${tag}`, href: `/tags/${tag}` }
];
---

<Layout title={`Tag: #${tag}`} description={`Articles tagged with #${tag}`} breadcrumbs={breadcrumbs}>
    <section class="page-header">
        <h1>#{tag}</h1>
        <p>{posts.length} pieces found.</p>
    </section>

	<section class="gallery">
		<div class="grid">
			{posts.map((post: any) => (
                /* 【修正】トップページと同じ「レイヤード・リンク構造」に統一 */
				<article class="card">
                    <div class="card-image">
                        {post.frontmatter.image && 
                        <img src={import.meta.env.BASE_URL + post.frontmatter.image} alt={post.frontmatter.title} loading="lazy" />
                        }
                    </div>
					<div class="content">
                        <div class="meta">
                            <span class="date">{post.frontmatter.artDate}</span>
                            {post.frontmatter.category && <span class="category-label">{post.frontmatter.category}</span>}
                        </div>
                        <h3>
                            <a href={post.url} class="main-link">
                                {post.frontmatter.title}
                            </a>
                        </h3>
                        <div class="tags">
                            {post.frontmatter.tags && post.frontmatter.tags.map((t: string) => (
                                <a href={`${baseUrl}/tags/${t}`} class="tag">#{t}</a>
                            ))}
                        </div>
                    </div>
				</article>
			))}
		</div>
	</section>
</Layout>