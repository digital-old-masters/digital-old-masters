---
import Layout from '../../../layouts/Layout.astro'; /* 階層が深くなったのでパス修正 */
import type { GetStaticPaths, Page } from 'astro';

interface Props {
  page: Page<any>;
  categoryName: string;
}

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = Object.values(import.meta.glob('../../posts/*.{md,mdx}', { eager: true }));
  const uniqueCategories = [...new Set(allPosts.map((post: any) => post.frontmatter.category).filter(Boolean))];
  
  // flatMapを使って、各カテゴリごとにページネーションを生成して結合する
  return uniqueCategories.flatMap((category) => {
    const filteredPosts = allPosts.filter((post: any) => 
      post.frontmatter.category === category
    ).sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime());
    
    return paginate(filteredPosts, {
      params: { category: (category as string).toLowerCase() },
      props: { categoryName: category },
      pageSize: 9
    });
  });
}) satisfies GetStaticPaths;

const { page, categoryName } = Astro.props;
const { category } = Astro.params;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');

const getPageUrl = (url: string | undefined) => {
    if (!url) return undefined;
    if (url.startsWith(baseUrl)) return url;
    return baseUrl + url;
};

const breadcrumbs = [
    { label: 'Home', href: '/' },
    { label: 'Archives', href: '/archives' },
    { label: categoryName, href: `/category/${category}` }
];
---

<Layout title={`Category: ${categoryName} (Page ${page.currentPage})`} description={`Articles in ${categoryName}`} breadcrumbs={breadcrumbs}>
    <section class="page-header" style="text-align:center; margin-bottom:3rem;">
        <h1>{categoryName}</h1>
        <p class="subtitle">{page.total} pieces found.</p>
    </section>

    <section class="gallery">
        <div class="grid">
            {page.data.map((post: any) => (
                <article class="card">
                    <div class="card-image">
                        {post.frontmatter.image && 
                        <img src={import.meta.env.BASE_URL + post.frontmatter.image} alt={post.frontmatter.title} loading="lazy" />
                        }
                    </div>
                    <div class="content">
                        <div class="meta">
                            <span class="date">{post.frontmatter.artDate}</span>
                        </div>
                        <h3>
                            <a href={post.url} class="main-link">
                                {post.frontmatter.title}
                            </a>
                        </h3>
                        <div class="tags">
                            {post.frontmatter.tags && post.frontmatter.tags.map((tag: string) => (
                                <a href={`${baseUrl}/tags/${tag}`} class="tag">#{tag}</a>
                            ))}
                        </div>
                    </div>
                </article>
            ))}
        </div>
    </section>

    {/* ページネーションUIの追加 */}
    {page.lastPage > 1 && (
        <nav class="pagination">
            {page.url.prev ? (
                <a href={getPageUrl(page.url.prev)} class="prev">← Prev</a>
            ) : <span class="disabled">← Prev</span>}
            
            <span class="current">Page {page.currentPage} of {page.lastPage}</span>

            {page.url.next ? (
                <a href={getPageUrl(page.url.next)} class="next">Next →</a>
            ) : <span class="disabled">Next →</span>}
        </nav>
    )}
</Layout>