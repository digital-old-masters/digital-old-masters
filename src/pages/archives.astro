---
import Layout from '../layouts/Layout.astro';

const allPosts = Object.values(import.meta.glob('./posts/*.{md,mdx}', { eager: true }))
    .sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime());

// 型定義の修正: acc に型 (Record<string, any[]>) を指定
const postsByYear = allPosts.reduce((acc: Record<string, any[]>, post: any) => {
    const year = new Date(post.frontmatter.artDate).getFullYear().toString();
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
}, {});
const years = Object.keys(postsByYear).sort((a, b) => b.localeCompare(a));

const categories = [...new Set(allPosts.map((post: any) => post.frontmatter.category).filter(Boolean))].sort();
const tags = [...new Set(allPosts.flatMap((post: any) => post.frontmatter.tags || []))].sort();

const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const breadcrumbs = [
    { label: 'Home', href: '/' },
    { label: 'Archives', href: '/archives' }
];
---

<Layout title="Archives" description="The complete timeline of works." breadcrumbs={breadcrumbs}>
    <section class="page-header">
        <h1>Archives</h1>
        <p class="subtitle">The complete collection.</p>
    </section>

    <div class="archive-container">
        <section class="archive-section timeline">
            <h2>Timeline</h2>
            <div class="timeline-list">
                {years.map(year => (
                    <div class="year-group">
                        <h3>{year}</h3>
                        <ul>
                            {postsByYear[year].map((post: any) => (
                                <li>
                                    <span class="date">{new Date(post.frontmatter.artDate).toLocaleDateString('en-US', {month:'short', day:'numeric'})}</span>
                                    <a href={post.url}>{post.frontmatter.title}</a>
                                </li>
                            ))}
                        </ul>
                    </div>
                ))}
            </div>
        </section>

        <aside class="archive-sidebar">
            <section class="archive-section">
                <h2>Categories</h2>
                <ul class="category-list">
                    {categories.map(category => (
                        <li>
                            <a href={`${baseUrl}/category/${(category as string).toLowerCase()}`}>{category}</a>
                        </li>
                    ))}
                </ul>
            </section>

            <section class="archive-section">
                <h2>Concept Tags</h2>
                <div class="tag-cloud">
                    {tags.map(tag => (
                        <a href={`${baseUrl}/tags/${tag}`} class="tag-link">#{tag}</a>
                    ))}
                </div>
            </section>
        </aside>
    </div>
</Layout>

<style>
    /* スタイルは変更なし */
    .page-header { text-align: center; margin-bottom: 4rem; }
    .page-header h1 { font-size: 2.5rem; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .subtitle { color: #888; font-style: italic; }

    .archive-container { display: grid; grid-template-columns: 2fr 1fr; gap: 4rem; }
    .archive-section h2 { font-size: 1.2rem; color: #999; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid #E0Dbd0; padding-bottom: 0.8rem; margin-bottom: 2rem; }

    .year-group { margin-bottom: 3rem; }
    .year-group h3 { font-size: 1.8rem; color: var(--c-accent); margin-bottom: 1rem; font-family: var(--font-serif); }
    .timeline-list ul { list-style: none; padding: 0; border-left: 2px solid #f0eadd; padding-left: 1.5rem; }
    .timeline-list li { margin-bottom: 1rem; position: relative; }
    .timeline-list li::before { content: ''; position: absolute; left: -1.5rem; top: 0.5em; width: 8px; height: 8px; background: #fff; border: 2px solid var(--c-accent); border-radius: 50%; transform: translate(-50%, -50%); }
    .timeline-list .date { color: #999; font-size: 0.85rem; margin-right: 1rem; min-width: 60px; display: inline-block; }
   .timeline-list a { 
        font-size: 1.1rem; 
        color: var(--c-text); /* 通常時は落ち着いた色 */
        text-decoration: none; /* 下線は引かない（シンプルさ維持） */
        transition: color 0.2s ease, opacity 0.2s ease; /* 滑らかな変化 */
    }

    /* 【追加】 ホバー時の美しい反応 */
    .timeline-list a:hover {
        color: var(--c-accent); /* アクセントカラー(#CD853F)に変化 */
        opacity: 0.8; /* わずかに透明にして奥行きを出す */
    }
    
    .category-list { list-style: none; padding: 0; }
    .category-list li { margin-bottom: 0.8rem; }
    .category-list a { font-size: 1.05rem; color: #555; display: block; padding: 0.3rem 0; border-bottom: 1px solid transparent; transition: all 0.2s; }
    .category-list a:hover { color: var(--c-accent); border-color: #f0eadd; padding-left: 0.5rem; }

    .tag-cloud { display: flex; gap: 0.8rem; flex-wrap: wrap; }
    .tag-link { font-size: 0.9rem; color: #888; padding: 0.3rem 0.8rem; border: 1px solid #E0Dbd0; border-radius: 20px; transition: all 0.2s; }
    .tag-link:hover { border-color: var(--c-accent); color: var(--c-accent); background: #fff; }

    @media (max-width: 768px) {
        .archive-container { grid-template-columns: 1fr; gap: 3rem; }
        .archive-sidebar { order: -1; }
    }
</style>