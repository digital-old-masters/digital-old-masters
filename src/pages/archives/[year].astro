---
/* src/pages/archives/[year].astro */
import Layout from '../../layouts/Layout.astro';
import '../../styles/components/card.css';
import '../../styles/layouts/archive.css';
import ArticleCard from '../../components/ArticleCard.astro';

export async function getStaticPaths() {
  const allPosts = Object.values(import.meta.glob('../posts/*.{md,mdx}', { eager: true }));
  const uniqueYears = [...new Set(allPosts.map((post: any) => 
    new Date(post.frontmatter.artDate).getFullYear().toString()
  ))];
  
  return uniqueYears.map((year) => {
    const filteredPosts = allPosts.filter((post: any) => 
      new Date(post.frontmatter.artDate).getFullYear().toString() === year
    ).sort((a: any, b: any) => new Date(b.frontmatter.artDate).getTime() - new Date(a.frontmatter.artDate).getTime());
    
    return {
      params: { year },
      props: { posts: filteredPosts },
    };
  });
}

const { year } = Astro.params;
const { posts } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');
const breadcrumbs = [
    { label: 'Home', href: '/' },
    { label: 'Archives', href: '/archives' },
    { label: year, href: `/archives/${year}` }
];
---

<Layout title={`Archives: ${year}`} description={`All works from ${year}`} breadcrumbs={breadcrumbs}>
    <section class="page-header">
        <h1>{year}</h1>
        <p class="subtitle">{posts.length} pieces found in this year.</p>
    </section>

    <section class="gallery">
       <div class="grid">
    {posts.map((post: any, index: number) => ( /* index を追加 */
        <ArticleCard 
                    post={post} 
                    variant="standard" 
                    loading={index === 0 ? "eager" : "lazy"} 
                />
            ))}
        </div>
    </section>

    <div style="text-align: center; margin-top: 4rem;">
        <a href={`${baseUrl}/archives`} style="color:#999; text-decoration: underline;">← Back to Archives Overview</a>
    </div>
</Layout>